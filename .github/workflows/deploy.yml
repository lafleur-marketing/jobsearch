name: Deploy to CapRover

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install CapRover CLI
      run: npm install -g caprover
      
    - name: Login to CapRover
      run: |
        caprover login -u https://captain.lf1.dev -p "${{ secrets.CAPROVER_PASSWORD }}" -n captain-01
        
    - name: Create deployment package
      run: |
        tar --exclude='.git' --exclude='node_modules' --exclude='.next' --exclude='.github' -czf jobsearch.tar.gz .
        
    - name: Deploy to CapRover
      run: |
        echo "Attempting deployment..."
        caprover deploy -n captain-01 -a jobsearch -t jobsearch.tar.gz || {
          echo "Deployment failed, checking if app is building..."
          echo "If the app is currently building, please wait and try again manually"
          echo "Or cancel the current build in CapRover dashboard"
          exit 1
        }
